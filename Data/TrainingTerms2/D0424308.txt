#Hadoop/gi中/fHDFS/nz读取/gi文件/gi的/ude1原理/gi剖析/gi
上/f一篇/nz文章/gi中/f简单/a介绍/gi了/ule一下/m文件/gi存储/gi的/ude1一/nz些/q逻辑/n与/cc简单/a原理/gi（/w见/v）/w，/w既/c然后/c写入/gi，/w那/rzv肯定/v要/v读取/gi分析/gi数据/gi咯/y，/w下面/f我/rr在/p白话/gi一下/mhdfs/gi中/f文件读取/gi的/ude1逻辑/n与/cc简单/a原理/gi。/w第一步/nz：/w跟/p写入/gi文件/gi一样/uyy，/w首先/d客户端/gi会/v调用/gidistributedfilesystem /nz对象/gi的/ude1open/nz（/w）/w方法/gi来/vf打开/gi文件/gi，/w这个/rz方法/gi要/v做/v的/ude1事情/n就是/v：/wdistributed filesystem/nz会/v通过/prpc/nz协议/gi连接/gi来/vf调用/ginamenode/gi，/wnamenode/gi里面/f存储/gi的/ude1都/d是/vshi文件/gi命名/v空间/n，/w也/d就是/v文件/gi存储/gi在/pdatanode/gi的/ude1地址/gi，/w我们/rr首先/d获取/gi到/v要/v想/v读取/gi的/ude1文件/gi头/n所在/n的/ude1位置/gi，/w块/q中/f存在/v很/d多/a个/q数据/gi节点/gi副本/n，/whadoop/gi会/v根据/p一定/b的/ude1标准/gi找到/v距离/gi客户端/gi最近/t的/ude1一个/mq节点/gi，/w此时/r便/d返回/v一个/mqfsdata inputstream/nz，/w否则/c返回/vioexception/nz第二步/nz：/w紧跟着/d，/w客户端/gi会/v读取/gi返回/v去/vf的/ude1文件/gi输入流/nz，/w此时/r文件/gi头/n存储/gi的/ude1datanode/gi会/v自己/rr寻找/v这些/rz块/q中距离/n自己/rr最近/t的/ude1其他/rzvdatanode/gi，/w并且/c建立/gi起/vf链接/gi，/w客户端/gi持续/vdread/nz，/w直到/v读取/gi到/v块/q的/ude1末尾/n。/w从/pnamenode/gi中/f找到/v下一个/nz块/q的/ude1地址/gi，/w并/cc找到/v最佳/z的/ude1文件/gi节点/gi位置/gi。/w持续/vd重复/gi上面/f的/ude1动作/gi。/w知道/v读取/gi完成/v之后/f，/w文件/gi输入/v流会/n调用/giclose/nz方法/gi关闭/gi流/gi，/w下面/f我们/rr讨论/gi下/f异常处理/gi的/ude1机制/gi：/w如果/c客户端/gi在/p读取/gi数据流/n的/ude1时候/n遇到/v了/ule错误/gi块/q，/w怎么办/ryvz/nz？/w如果/c客户端/gi遇到/v了/ule异常/gi块/q，/w那么/c客户端/gi就/d会/v记录下来/l这个/rz块/q，/w并/cc尝试/v去/vf读取/gi距离/gi这个/rz块/q最近/t的/ude1一个块/nz，/w并且/c不会/v再/d去/vf读取/gi这个/rz损坏/v的/ude1块/q。/w同时/c客户端/gi还/d会/v去/vf校验/v接受/gi到/v的/ude1数据/gi的/ude1校验/v和/cc，/w若/c发现/v一个/mq损坏/v的/ude1块/q，/w它/rr就/d会/v在/p客户端/gi试图/v从/p别的/rzv数据/gi节点/gi中/f读取/gi一个块/nz的/ude1副本/n之前/f报告/gi给/p名称/n节点/gi。/w在/p之前/f我们/rr一直/d提到/v的/ude1hadoop/gi的/ude1寻找/v最近/t的/ude1块/q或者/c节点/gi的/ude1机制/gi是/vshi如何/ryv实现/gi呢/y？/w我们/rr都/d知道/v。/w在/p大数据存储/gi中/f，/w限制/vn效率/gi的/ude1最主要/nz因素/gi就是/v带宽/n。/whadoop/gi将/d网络/gi看成/v一棵树/nz，/w两/nz个/q节点/gi间/f的/ude1距离/gi是/vshi距离/gi它们/rr最近/t的/ude1共同/d祖先/n的/ude1总和/n。/w对于/p以下/f每个/r场景/gi，/w可用/v带宽/n依次/d减少/v：/w相同/a节点/gi中的/v进程/gi同一/b机/ng架上/s的/ude1不同/a节点/gi同一/b数据中心/gi的/ude1不同/a机架/n上/f的/ude1节点/gi不同/a数据中心/gi的/ude1节点/gi